#!/usr/bin/env python3
"""
Pre-commit hook: validates changed skills and regenerates skill-index.yaml.

Setup:
    git config core.hooksPath .githooks

Requires:
    Python 3.9+
"""

import subprocess
import sys
from pathlib import Path


def run(cmd: list[str], **kwargs) -> subprocess.CompletedProcess:
    """Run a command and return the result."""
    return subprocess.run(cmd, capture_output=True, text=True, **kwargs)


def get_repo_root() -> Path:
    result = run(["git", "rev-parse", "--show-toplevel"])
    return Path(result.stdout.strip())


def get_staged_files() -> list[str]:
    """Return list of staged file paths (relative to repo root)."""
    result = run(["git", "diff", "--cached", "--name-only"])
    return [line for line in result.stdout.strip().splitlines() if line]


def validate_skills(repo_root: Path) -> bool:
    """Run the skill validation script. Returns True if validation passes."""
    script = repo_root / "scripts" / "validate-skill.sh"
    result = run([str(script)], cwd=repo_root)
    print(result.stdout, end="")
    if result.returncode != 0:
        print(result.stderr, end="", file=sys.stderr)
    return result.returncode == 0


def regenerate_index(repo_root: Path) -> bool:
    """Run the index generation script and stage the result. Returns True on success."""
    script = repo_root / "scripts" / "generate-index.sh"
    result = run([str(script)], cwd=repo_root)
    print(result.stdout, end="")
    if result.returncode != 0:
        print(result.stderr, end="", file=sys.stderr)
        return False

    index_file = repo_root / "skill-index.yaml"
    run(["git", "add", str(index_file)])
    return True


def main() -> int:
    repo_root = get_repo_root()
    staged_files = get_staged_files()

    skills_changed = any(f.startswith("skills/") for f in staged_files)
    metadata_changed = any(f.endswith("skill-metadata.yaml") for f in staged_files)

    # Validate if any skill files changed
    if skills_changed:
        print("Skills changed — running validation...")
        if not validate_skills(repo_root):
            print("Skill validation failed. Fix errors before committing.")
            return 1

    # Regenerate index if any metadata changed
    if metadata_changed:
        print("Metadata changed — regenerating skill-index.yaml...")
        if not regenerate_index(repo_root):
            print("Index generation failed.")
            return 1

    return 0


if __name__ == "__main__":
    sys.exit(main())
